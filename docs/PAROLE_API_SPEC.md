# ğŸ“¡ Parole APIä»•æ§˜æ›¸

## æ¦‚è¦

Paroleæ©Ÿèƒ½ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è©³ç´°ä»•æ§˜ã§ã™ã€‚

---

## 1. ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ä¿å­˜API

### **POST /api/chat** (æ—¢å­˜APIã®æ‹¡å¼µ)

ãƒãƒ£ãƒƒãƒˆAPIã«ãƒ­ã‚°ä¿å­˜æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ã€‚

#### **ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£**

```typescript
{
  question: string;        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•
  history?: [string, string][];  // ãƒãƒ£ãƒƒãƒˆå±¥æ­´
  site_id?: string;       // ã‚µã‚¤ãƒˆID
  session_id?: string;    // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€æœªæŒ‡å®šã®å ´åˆã¯è‡ªå‹•ç”Ÿæˆï¼‰
}
```

#### **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**

ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å½¢å¼ï¼ˆæ—¢å­˜ã¨åŒã˜ï¼‰

#### **å†…éƒ¨å‡¦ç†**

1. ãƒãƒ£ãƒƒãƒˆå‡¦ç†ã‚’å®Ÿè¡Œ
2. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å®Œäº†å¾Œã€`chat_logs`ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
3. ãƒ­ã‚°ä¿å­˜ã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã«ã¯å½±éŸ¿ã—ãªã„ï¼‰

#### **ä¿å­˜ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿**

```typescript
{
  user_id: string;        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  site_id: string | null; // ã‚µã‚¤ãƒˆID
  question: string;       // è³ªå•å†…å®¹
  answer: string;         // å›ç­”å†…å®¹
  session_id: string;    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ID
  source: 'dashboard';    // ç™ºç”Ÿå…ƒ
  user_agent: string | null;
  referrer: string | null;
  created_at: timestamp;
}
```

---

### **POST /api/embed/chat** (æ—¢å­˜APIã®æ‹¡å¼µ)

åŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆAPIã«ãƒ­ã‚°ä¿å­˜æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ã€‚

#### **ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£**

```typescript
{
  question: string;
  history?: [string, string][];
  site_id: string;         // å¿…é ˆ
  session_id?: string;    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³
}
```

#### **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**

ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å½¢å¼ï¼ˆæ—¢å­˜ã¨åŒã˜ï¼‰

#### **ä¿å­˜ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿**

```typescript
{
  user_id: string;        // ã‚µã‚¤ãƒˆã®æ‰€æœ‰è€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  site_id: string;
  question: string;
  answer: string;
  session_id: string;
  source: 'embed';        // åŸ‹ã‚è¾¼ã¿ã‹ã‚‰ã®å‘¼ã³å‡ºã—
  user_agent: string | null;
  referrer: string | null;
  created_at: timestamp;
}
```

---

## 2. è³ªå•ãƒ©ãƒ³ã‚­ãƒ³ã‚°API

### **GET /api/insights/questions**

æŒ‡å®šã—ãŸã‚µã‚¤ãƒˆã®è³ªå•ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—ã—ã¾ã™ã€‚

#### **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**

```
GET /api/insights/questions
```

#### **ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å‹ | å¿…é ˆ | èª¬æ˜ |
|---------|-----|------|------|
| `site_id` | string | âœ… | ã‚µã‚¤ãƒˆID |
| `start_date` | string | âŒ | é–‹å§‹æ—¥æ™‚ï¼ˆISO 8601å½¢å¼ï¼‰ |
| `end_date` | string | âŒ | çµ‚äº†æ—¥æ™‚ï¼ˆISO 8601å½¢å¼ï¼‰ |
| `limit` | number | âŒ | å–å¾—ä»¶æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 10ï¼‰ |

#### **èªè¨¼**

Bearer Tokenèªè¨¼ãŒå¿…è¦ã§ã™ã€‚

```
Authorization: Bearer <access_token>
```

#### **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**

```json
{
  "site_id": "123e4567-e89b-12d3-a456-426614174000",
  "period": {
    "start": "2024-12-01T00:00:00Z",
    "end": "2024-12-31T23:59:59Z"
  },
  "questions": [
    {
      "question": "ä¾¡æ ¼ã¯ã„ãã‚‰ã§ã™ã‹ï¼Ÿ",
      "count": 45,
      "first_asked_at": "2024-12-01T10:30:00Z",
      "last_asked_at": "2024-12-31T15:20:00Z"
    },
    {
      "question": "ã©ã®ã‚ˆã†ãªæ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
      "count": 32,
      "first_asked_at": "2024-12-02T09:15:00Z",
      "last_asked_at": "2024-12-30T14:45:00Z"
    }
  ]
}
```

#### **ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹**

**400 Bad Request**
```json
{
  "message": "site_id is required"
}
```

**401 Unauthorized**
```json
{
  "message": "Unauthorized"
}
```

**403 Forbidden**
```json
{
  "message": "Forbidden"
}
```

**404 Not Found**
```json
{
  "message": "Site not found"
}
```

**500 Internal Server Error**
```json
{
  "message": "Failed to fetch question ranking",
  "error": "Error details"
}
```

---

## 3. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æAPI

### **GET /api/insights/keywords**

æŒ‡å®šã—ãŸã‚µã‚¤ãƒˆã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å‡ºç¾é »åº¦ã‚’å–å¾—ã—ã¾ã™ã€‚

#### **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**

```
GET /api/insights/keywords
```

#### **ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å‹ | å¿…é ˆ | èª¬æ˜ |
|---------|-----|------|------|
| `site_id` | string | âœ… | ã‚µã‚¤ãƒˆID |
| `start_date` | string | âŒ | é–‹å§‹æ—¥æ™‚ï¼ˆISO 8601å½¢å¼ï¼‰ |
| `end_date` | string | âŒ | çµ‚äº†æ—¥æ™‚ï¼ˆISO 8601å½¢å¼ï¼‰ |
| `limit` | number | âŒ | å–å¾—ä»¶æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 20ï¼‰ |

#### **èªè¨¼**

Bearer Tokenèªè¨¼ãŒå¿…è¦ã§ã™ã€‚

#### **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**

```json
{
  "site_id": "123e4567-e89b-12d3-a456-426614174000",
  "period": {
    "start": "2024-12-01T00:00:00Z",
    "end": "2024-12-31T23:59:59Z"
  },
  "keywords": [
    {
      "keyword": "ä¾¡æ ¼",
      "count": 125
    },
    {
      "keyword": "æ©Ÿèƒ½",
      "count": 98
    },
    {
      "keyword": "ä½¿ã„æ–¹",
      "count": 76
    }
  ]
}
```

#### **ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹**

è³ªå•ãƒ©ãƒ³ã‚­ãƒ³ã‚°APIã¨åŒã˜ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã§ã™ã€‚

---

## 4. æ™‚ç³»åˆ—åˆ†æAPI

### **GET /api/insights/timeline**

æŒ‡å®šã—ãŸã‚µã‚¤ãƒˆã®è³ªå•æ•°ã®æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚

#### **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**

```
GET /api/insights/timeline
```

#### **ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å‹ | å¿…é ˆ | èª¬æ˜ |
|---------|-----|------|------|
| `site_id` | string | âœ… | ã‚µã‚¤ãƒˆID |
| `start_date` | string | âŒ | é–‹å§‹æ—¥æ™‚ï¼ˆISO 8601å½¢å¼ï¼‰ |
| `end_date` | string | âŒ | çµ‚äº†æ—¥æ™‚ï¼ˆISO 8601å½¢å¼ï¼‰ |
| `interval` | string | âŒ | é›†è¨ˆé–“éš”ï¼ˆ'day', 'week', 'month'ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'day'ï¼‰ |

#### **èªè¨¼**

Bearer Tokenèªè¨¼ãŒå¿…è¦ã§ã™ã€‚

#### **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**

```json
{
  "site_id": "123e4567-e89b-12d3-a456-426614174000",
  "period": {
    "start": "2024-12-01T00:00:00Z",
    "end": "2024-12-31T23:59:59Z"
  },
  "interval": "day",
  "timeline": [
    {
      "period_start": "2024-12-01T00:00:00Z",
      "question_count": 15
    },
    {
      "period_start": "2024-12-02T00:00:00Z",
      "question_count": 23
    },
    {
      "period_start": "2024-12-03T00:00:00Z",
      "question_count": 18
    }
  ]
}
```

#### **ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹**

**400 Bad Request** (intervalãŒç„¡åŠ¹ãªå ´åˆ)
```json
{
  "message": "interval must be one of: day, week, month"
}
```

ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯è³ªå•ãƒ©ãƒ³ã‚­ãƒ³ã‚°APIã¨åŒã˜å½¢å¼ã§ã™ã€‚

---

## 5. ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ä¸€è¦§APIï¼ˆå°†æ¥å®Ÿè£…ï¼‰

### **GET /api/insights/logs**

ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã®ä¸€è¦§ã‚’å–å¾—ã—ã¾ã™ã€‚

#### **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**

```
GET /api/insights/logs
```

#### **ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å‹ | å¿…é ˆ | èª¬æ˜ |
|---------|-----|------|------|
| `site_id` | string | âœ… | ã‚µã‚¤ãƒˆID |
| `start_date` | string | âŒ | é–‹å§‹æ—¥æ™‚ |
| `end_date` | string | âŒ | çµ‚äº†æ—¥æ™‚ |
| `limit` | number | âŒ | å–å¾—ä»¶æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 50ï¼‰ |
| `offset` | number | âŒ | ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0ï¼‰ |
| `search` | string | âŒ | è³ªå•å†…å®¹ã®æ¤œç´¢ |

#### **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**

```json
{
  "site_id": "123e4567-e89b-12d3-a456-426614174000",
  "total": 150,
  "logs": [
    {
      "id": "log-123",
      "question": "ä¾¡æ ¼ã¯ã„ãã‚‰ã§ã™ã‹ï¼Ÿ",
      "answer": "ãƒ—ãƒ©ãƒ³ã¯3ç¨®é¡ã‚ã‚Šã¾ã™...",
      "session_id": "session-456",
      "source": "embed",
      "created_at": "2024-12-15T10:30:00Z"
    }
  ]
}
```

---

## 6. CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆAPIï¼ˆå°†æ¥å®Ÿè£…ï¼‰

### **GET /api/insights/export**

ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã‚’CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

#### **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**

```
GET /api/insights/export
```

#### **ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**

ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ä¸€è¦§APIã¨åŒã˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

#### **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**

CSVãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆContent-Type: text/csvï¼‰

```csv
è³ªå•,å›ç­”,ã‚»ãƒƒã‚·ãƒ§ãƒ³ID,ç™ºç”Ÿå…ƒ,ä½œæˆæ—¥æ™‚
ä¾¡æ ¼ã¯ã„ãã‚‰ã§ã™ã‹ï¼Ÿ,ãƒ—ãƒ©ãƒ³ã¯3ç¨®é¡ã‚ã‚Šã¾ã™...,session-456,embed,2024-12-15T10:30:00Z
```

---

## 7. ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°APIï¼ˆPhase 2ï¼‰

### **POST /api/insights/cluster**

è³ªå•ã‚’ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚

#### **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**

```
POST /api/insights/cluster
```

#### **ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£**

```json
{
  "site_id": "123e4567-e89b-12d3-a456-426614174000",
  "min_cluster_size": 3,
  "similarity_threshold": 0.8
}
```

#### **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**

```json
{
  "site_id": "123e4567-e89b-12d3-a456-426614174000",
  "clusters": [
    {
      "id": "cluster-1",
      "representative_question": "ä¾¡æ ¼ã¯ã„ãã‚‰ã§ã™ã‹ï¼Ÿ",
      "question_count": 45,
      "keywords": ["ä¾¡æ ¼", "æ–™é‡‘", "è²»ç”¨"],
      "category": "ä¾¡æ ¼"
    }
  ],
  "processing_time_ms": 1234
}
```

---

## å…±é€šä»•æ§˜

### **èªè¨¼**

ã™ã¹ã¦ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯Supabaseã®JWTèªè¨¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
Authorization: Bearer <supabase_access_token>
```

### **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**

ã™ã¹ã¦ã®APIã¯ä»¥ä¸‹ã®å½¢å¼ã§ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã™ï¼š

```json
{
  "message": "Error message",
  "error": "Detailed error information (optional)"
}
```

### **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**

ç¾åœ¨ã¯ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãªã—ã€‚å°†æ¥çš„ã«å®Ÿè£…äºˆå®šã€‚

### **ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°**

ç¾åœ¨ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãªã—ã€‚å°†æ¥çš„ã«`/api/v1/insights/...`å½¢å¼ã‚’æ¤œè¨ã€‚

---

## å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] `/api/insights/questions` ã®å®Ÿè£…
- [ ] `/api/insights/keywords` ã®å®Ÿè£…
- [ ] `/api/insights/timeline` ã®å®Ÿè£…
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€
- [ ] èªè¨¼ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…
- [ ] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…
- [ ] ãƒ­ã‚°å‡ºåŠ›ã®å®Ÿè£…
- [ ] ãƒ†ã‚¹ãƒˆã®ä½œæˆ

